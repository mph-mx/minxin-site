<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minxin Book Manager</title>
  <style>
    :root {
      --primary: #003366;
      --secondary: #4a90e2;
      --bg: #f4f7f6;
      --border: #ddd;
    }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
    
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    h1, h2 { color: var(--primary); margin-top: 0; }
    
    /* Layout */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full-width { grid-column: 1 / -1; }
    
    /* Form Elements */
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
    textarea { height: 80px; resize: vertical; }
    
    /* Buttons */
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
    .btn-primary { background: var(--primary); }
    .btn-success { background: #28a745; }
    .btn-download { background: #d32f2f; display: block; width: 100%; text-align: center; margin-top: 20px; font-size: 1.1rem; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }

    /* File Upload */
    .upload-zone { border: 2px dashed var(--border); padding: 30px; text-align: center; margin-bottom: 20px; background: #fafafa; }
    
    /* Table */
    .table-container { margin-top: 30px; max-height: 500px; overflow-y: auto; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: var(--primary); color: white; position: sticky; top: 0; }
    tr:hover { background: #f1f1f1; }
    
    /* Status Bar */
    .status-bar { background: #e8f0fe; color: #1a73e8; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }

    /* Helper Classes */
    .hidden { display: none; }
    .row { display: flex; gap: 10px; }
  </style>
</head>
<body>

<div class="container">
  <h1>Minxin Library Manager</h1>

  <!-- STEP 1: LOAD -->
  <div id="loadSection" class="upload-zone">
    <h2>Step 1: Load existing books.json</h2>
    <p>Select your current <code>books.json</code> file to begin editing.</p>
    <input type="file" id="fileInput" accept=".json">
  </div>

  <!-- MAIN EDITOR (Hidden until loaded) -->
  <div id="editorSection" class="hidden">
    
    <div class="status-bar">
      <span id="bookCount">Loaded: 0 books</span>
      <button class="btn btn-primary" onclick="showAddForm()">+ Add New Book</button>
    </div>

    <!-- ADD BOOK FORM -->
    <div id="addForm" class="hidden" style="background: #f8f9fa; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px;">
      <h2>Add New Book</h2>
      <form id="bookForm">
        <div class="grid">
          
          <div class="form-group">
            <label>Division</label>
            <select id="division" onchange="generateNextID()">
              <option value="SD-English">SD-English</option>
              <option value="SD-Chinese">SD-Chinese</option>
              <option value="PD-English">PD-English</option>
            </select>
          </div>

          <div class="form-group">
            <label>Auto-Generated ID</label>
            <input type="text" id="bookId" readonly style="background: #e9ecef; color: #555;">
          </div>

          <div class="form-group full-width">
            <label>Title</label>
            <input type="text" id="title" required placeholder="e.g. Harry Potter">
          </div>

          <div class="form-group full-width">
            <label>Author</label>
            <input type="text" id="author" required placeholder="e.g. J.K. Rowling">
          </div>

          <div class="form-group full-width">
            <label>Description</label>
            <textarea id="description" placeholder="Short synopsis..."></textarea>
          </div>

          <div class="form-group">
            <label>Primary Genre (Select one)</label>
            <select id="genreSelect">
              <option value="Adventure & Survival">Adventure & Survival</option>
              <option value="Classics & Canon">Classics & Canon</option>
              <option value="Fantasy Worlds">Fantasy Worlds</option>
              <option value="Historical & War">Historical & War</option>
              <option value="Horror & Supernatural">Horror & Supernatural</option>
              <option value="Humour & Feel-Good">Humour & Feel-Good</option>
              <option value="Mystery, Crime & Thrillers">Mystery, Crime & Thrillers</option>
              <option value="Non-Fiction, Biography & Memoir">Non-Fiction, Biography & Memoir</option>
              <option value="Poetry, Verse & Short Stories">Poetry, Verse & Short Stories</option>
              <option value="Reference, Study & Dictionaries">Reference, Study & Dictionaries</option>
              <option value="Romance & Relationships">Romance & Relationships</option>
              <option value="School, Family & Growing Up">School, Family & Growing Up</option>
              <option value="Sci-Fi & Dystopia">Sci-Fi & Dystopia</option>
              <option value="Social Issues & Justice">Social Issues & Justice</option>
              <option value="Sport">Sport</option>
              <option value="Picture Book">Picture Book (PD)</option>
              <option value="Graphic Novel">Graphic Novel</option>
            </select>
          </div>

          <div class="form-group">
            <label>Reading Level (SD Only)</label>
            <select id="readingLevel">
              <option value="">-- None --</option>
              <option value="Explorer">Explorer</option>
              <option value="Adventurer">Adventurer</option>
              <option value="Voyager">Voyager</option>
              <option value="Galactic">Galactic</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>Image Filename</label>
            <div class="row">
              <span style="padding: 8px; background: #eee; border: 1px solid #ddd; border-right: none; border-radius: 4px 0 0 4px;">images/</span>
              <input type="text" id="imageName" required placeholder="my_book_cover.jpg" style="border-radius: 0 4px 4px 0;">
            </div>
            <small style="color: #666;">Make sure you upload this exact file to your 'images' folder on GitHub.</small>
          </div>

        </div>
        <div style="margin-top: 20px; text-align: right;">
          <button type="button" class="btn" onclick="hideAddForm()" style="background: #666; margin-right: 10px;">Cancel</button>
          <button type="submit" class="btn btn-success">Save to List</button>
        </div>
      </form>
    </div>

    <!-- TABLE -->
    <div class="table-container">
      <table id="bookTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Division</th>
            <th>Genre</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows inserted here -->
        </tbody>
      </table>
    </div>

    <!-- DOWNLOAD -->
    <button class="btn btn-download" onclick="downloadJSON()">Step 2: Download Updated books.json</button>

  </div>
</div>

<script>
  let books = [];

  const GENRE_PILL_MAP = {
    "Adventure & Survival": "Adventure",
    "Classics & Canon": "Classics",
    "Fantasy Worlds": "Fantasy",
    "Historical & War": "Historical",
    "Horror & Supernatural": "Horror",
    "Humour & Feel-Good": "Humour",
    "Mystery, Crime & Thrillers": "Mystery",
    "Non-Fiction, Biography & Memoir": "Non-Fiction",
    "Poetry, Verse & Short Stories": "Poetry",
    "Reference, Study & Dictionaries": "Reference",
    "Romance & Relationships": "Romance",
    "School, Family & Growing Up": "School",
    "Sci-Fi & Dystopia": "Sci-Fi",
    "Social Issues & Justice": "Social",
    "Sport": "Sport",
    "Picture Book": "Picture Book",
    "Graphic Novel": "Graphic Novel"
  };

  // 1. FILE LOAD
  document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        books = JSON.parse(e.target.result);
        initEditor();
      } catch (err) {
        alert("Error parsing JSON file. Please make sure it's valid.");
      }
    };
    reader.readAsText(file);
  });

  function initEditor() {
    document.getElementById('loadSection').classList.add('hidden');
    document.getElementById('editorSection').classList.remove('hidden');
    renderTable();
    updateCount();
  }

  function updateCount() {
    document.getElementById('bookCount').textContent = `Total Books: ${books.length}`;
  }

  // 2. RENDER TABLE
  function renderTable() {
    const tbody = document.querySelector('#bookTable tbody');
    tbody.innerHTML = '';

    // Show newest first (at the top)
    const reversedBooks = [...books].reverse(); 

    reversedBooks.forEach(book => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${book.id || '-'}</td>
        <td><strong>${book.title}</strong></td>
        <td>${book.author}</td>
        <td><span style="font-size:0.8em; padding:2px 6px; background:#eee; border-radius:4px;">${book.division}</span></td>
        <td>${(book.genre_pills || []).join(', ')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 3. ADD BOOK LOGIC
  function showAddForm() {
    document.getElementById('addForm').classList.remove('hidden');
    document.getElementById('bookForm').reset();
    generateNextID(); // Run ID generator initially
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function hideAddForm() {
    document.getElementById('addForm').classList.add('hidden');
  }

  function generateNextID() {
    const division = document.getElementById('division').value;
    // Determine prefix (sd- or pd-)
    let prefix = 'sd-';
    if (division.includes('PD')) prefix = 'pd-';

    // Find highest ID with this prefix
    let maxNum = 0;
    books.forEach(b => {
      if (b.id && b.id.toLowerCase().startsWith(prefix)) {
        const numPart = parseInt(b.id.split('-')[1]);
        if (!isNaN(numPart) && numPart > maxNum) {
          maxNum = numPart;
        }
      }
    });

    // Generate next
    const nextNum = maxNum + 1;
    // Pad with zeros (001, 002... 010... 100)
    const padded = String(nextNum).padStart(3, '0');
    document.getElementById('bookId').value = `${prefix}${padded}`;
  }

  document.getElementById('bookForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const division = document.getElementById('division').value;
    const genre = document.getElementById('genreSelect').value;
    const genrePill = GENRE_PILL_MAP[genre] || genre;
    
    // Construct new book object
    const newBook = {
      id: document.getElementById('bookId').value,
      title: document.getElementById('title').value,
      author: document.getElementById('author').value,
      description: document.getElementById('description').value,
      genres: [genre],
      genre_pills: [genrePill], // Auto-mapped
      reading_level: document.getElementById('readingLevel').value,
      image: "images/" + document.getElementById('imageName').value,
      division: division,
      language: division.includes('Chinese') ? "Chinese" : "English"
    };

    // Add logic for PD Age Band if needed (omitted for simplicity, but can be added)
    if (division.includes('PD')) {
      newBook.age_band = "Grades K-6"; // Default placeholder
    }

    // Add to main array
    books.push(newBook);

    // Refresh UI
    renderTable();
    updateCount();
    hideAddForm();
    alert(`Added "${newBook.title}" successfully! Don't forget to download the updated JSON.`);
  });

  // 4. DOWNLOAD
  function downloadJSON() {
    const dataStr = JSON.stringify(books, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = "books.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>

</body>
</html>