<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸­å­¦éƒ¨é˜…è¯»ä¹¦å•ï¼ˆä¸­æ–‡ï¼‰</title>
  <link rel="stylesheet" href="css/styles.css?v=7">
</head>

<body class="sd-cn">

<header>
  <div class="title-block">
    <a href="index.html" class="back-link">â† è¿”å›</a>
    <img src="images/logo.png?v=4" alt="Minxin Logo" class="header-logo">
    <div>
      <h1>ä¸­å­¦éƒ¨é˜…è¯»ä¹¦å•ï¼ˆä¸­æ–‡ï¼‰</h1>
      <p>æŒ‰ç±»åˆ«æµè§ˆï¼Œæˆ–æŸ¥çœ‹å…¨éƒ¨ä¹¦ç±ã€‚</p>
    </div>
  </div>

  <div class="search-block">
    <input id="searchInput" type="search" placeholder="æœç´¢ä¹¦åã€ä½œè€…æˆ–ç±»åˆ«â€¦">

    <div class="genre-filter">
      <select id="genreFilter">
        <option value="">å…¨éƒ¨ç±»åˆ«</option>
      </select>
    </div>

    <div class="toggle-group" id="viewToggle">
      <button id="viewNetflix" class="active">æµè§ˆ</button>
      <button id="viewGridList">å…¨éƒ¨ä¹¦ç±</button>
      <button id="filterFavorites" class="fav-toggle">â¤ï¸ æ”¶è—</button>
      <button id="darkModeToggle" class="fav-toggle">ğŸŒ™ å¤œé—´</button>
    </div>
  </div>
</header>

<main>

  <!-- Netflixé£æ ¼æ¨ªæ’åˆ†ç±» -->
  <div id="genreRowsContainer"></div>

  <!-- å…¨éƒ¨ä¹¦ç± -->
  <section id="gridListSection" class="hidden">
    <h2 id="gridListHeading">å…¨éƒ¨ä¹¦ç±</h2>
    <div id="gridListContainer" class="grid"></div>
  </section>

</main>

<script src="js/book-ui.js?v=4"></script>

<script>
const STATE = {
  books: [],
  filteredBooks: []
};

/* ---------------------------------------------------------
   UTILITIES
--------------------------------------------------------- */
function createPills(book) {
  const wrap = document.createElement("div");

  if (book.genres) {
    book.genres.forEach(g => {
      const span = document.createElement("span");
      span.className = "pill-genre";
      span.textContent = g;
      wrap.appendChild(span);
    });
  }

  if (book.age_band) {
    const span = document.createElement("span");
    span.className = "pill-level";
    span.textContent = book.age_band;
    wrap.appendChild(span);
  }

  return wrap;
}

/* ---------------------------------------------------------
   CARD CREATORS
--------------------------------------------------------- */
function createGridCard(book) {
  const card = document.createElement("article");
  card.className = "book-card";

  const overlay = document.createElement("div");
  overlay.className = "book-overlay";
  overlay.textContent = book.description || "æš‚æ— ç®€ä»‹";

  const img = document.createElement("img");
  img.src = book.image;
  img.alt = `${book.title} å°é¢`;
  img.loading = "lazy";

  const body = document.createElement("div");
  body.className = "book-body";

  const title = document.createElement("h3");
  title.className = "book-title";
  title.textContent = book.title;

  const author = document.createElement("div");
  author.className = "book-author";
  author.textContent = book.author;

  const meta = document.createElement("div");
  meta.className = "book-meta";
  meta.textContent = book.age_band || "";

  const pills = createPills(book);

  body.appendChild(title);
  body.appendChild(author);
  body.appendChild(meta);
  body.appendChild(pills);

  card.appendChild(overlay);
  card.appendChild(img);
  card.appendChild(body);

  BookUI.attachCard(card, book, STATE.books);
  return card;
}

function createListCard(book) {
  const card = document.createElement("article");
  card.className = "book-card-list";

  const img = document.createElement("img");
  img.src = book.image;
  img.alt = `${book.title} å°é¢`;
  img.loading = "lazy";

  const body = document.createElement("div");
  body.className = "book-body";

  const title = document.createElement("h3");
  title.className = "book-title";
  title.textContent = book.title;

  const author = document.createElement("div");
  author.className = "book-author";
  author.textContent = book.author;

  const meta = document.createElement("div");
  meta.className = "book-meta";
  meta.textContent =
    `${book.age_band || ""} Â· ${(book.genres || []).join("ã€")}`;

  const desc = document.createElement("div");
  desc.className = "book-description";
  desc.textContent = book.description || "";

  const pills = createPills(book);

  body.appendChild(title);
  body.appendChild(author);
  body.appendChild(meta);
  body.appendChild(desc);
  body.appendChild(pills);

  card.appendChild(img);
  card.appendChild(body);

  BookUI.attachCard(card, book, STATE.books);
  return card;
}

/* ---------------------------------------------------------
   APPLY FILTERS
--------------------------------------------------------- */
function applyFilters() {
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const genre = document.getElementById("genreFilter").value;
  const favToggle = document.getElementById("filterFavorites");
  const favoritesOnly = favToggle && favToggle.classList.contains("active");

  STATE.filteredBooks = STATE.books.filter(b => {
    const matchesText =
      !q ||
      (b.title && b.title.toLowerCase().includes(q)) ||
      (b.author && b.author.toLowerCase().includes(q)) ||
      (b.genres || []).some(g => g.toLowerCase().includes(q));

    const matchesGenre = !genre || (b.genres || []).includes(genre);
    const matchesFav = !favoritesOnly || BookUI.isFavorite(b);

    return matchesText && matchesGenre && matchesFav;
  });

  // â˜… Correct "empty favorites" area
  if (favoritesOnly && STATE.filteredBooks.length === 0) {
    const container = document.getElementById("gridListContainer");
    container.innerHTML = `
      <div class="favorites-empty">
        â¤ï¸ æš‚æ— æ”¶è—ä¹¦ç±ã€‚<br>
        ç‚¹å‡»ä¹¦ç±å³ä¸Šè§’çš„çº¢å¿ƒå³å¯æ”¶è—ã€‚
      </div>
    `;
    return;
  }

  const heading = document.getElementById("gridListHeading");
  heading.textContent =
    !q && !genre && !favoritesOnly
      ? "å…¨éƒ¨ä¹¦ç±"
      : `æœç´¢ç»“æœï¼ˆ${STATE.filteredBooks.length}ï¼‰`;

  renderGridOrList(isListMode());
}

function isListMode() {
  return document.getElementById("viewGridList").classList.contains("active");
}

function renderGridOrList(mode) {
  const container = document.getElementById("gridListContainer");
  container.className = mode;
  container.innerHTML = "";

  STATE.filteredBooks.forEach(book => {
    const card = mode === "list" ? createListCard(book) : createGridCard(book);
    container.appendChild(card);
  });
}

/* ---------------------------------------------------------
   SHOW SECTIONS
--------------------------------------------------------- */
function showNetflix() {
  document.getElementById("gridListSection").classList.add("hidden");
  document.getElementById("genreRowsContainer").classList.remove("hidden");
}

function showGridList() {
  document.getElementById("gridListSection").classList.remove("hidden");
  document.getElementById("genreRowsContainer").classList.add("hidden");
}

/* ---------------------------------------------------------
   GENRE ROWS
--------------------------------------------------------- */
function renderGenreRows() {
  const container = document.getElementById("genreRowsContainer");
  container.innerHTML = "";

  const byGenre = {};
  STATE.books.forEach(b => {
    (b.genres || []).forEach(g => {
      if (!byGenre[g]) byGenre[g] = [];
      byGenre[g].push(b);
    });
  });

  Object.entries(byGenre).forEach(([genre, books]) => {
    const row = document.createElement("div");
    row.className = "genre-row";

    const header = document.createElement("div");
    header.className = "genre-row-header";
    header.innerHTML = `<h2>${genre}</h2>`;
    row.appendChild(header);

    const scroll = document.createElement("div");
    scroll.className = "genre-scroll";

    books.forEach(book => {
      const card = createGridCard(book);
      scroll.appendChild(card);
    });

    row.appendChild(scroll);
    container.appendChild(row);
  });
}

/* ---------------------------------------------------------
   LOAD BOOKS
--------------------------------------------------------- */
async function loadBooks() {
  const res = await fetch("books.json");
  const data = await res.json();
  STATE.books = data.sd_cn || [];

  const genreSet = new Set();
  STATE.books.forEach(b =>
    (b.genres || []).forEach(g => genreSet.add(g))
  );

  const genreFilter = document.getElementById("genreFilter");
  genreSet.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    genreFilter.appendChild(opt);
  });

  renderGenreRows();
}

/* ---------------------------------------------------------
   EVENTS
--------------------------------------------------------- */
function initEvents() {
  document.getElementById("viewNetflix").addEventListener("click", () => {
    document.getElementById("viewNetflix").classList.add("active");
    document.getElementById("viewGridList").classList.remove("active");
    showNetflix();
  });

  document.getElementById("viewGridList").addEventListener("click", () => {
    document.getElementById("viewGridList").classList.add("active");
    document.getElementById("viewNetflix").classList.remove("active");
    showGridList();
    applyFilters();
  });

  document.getElementById("genreFilter").addEventListener("change", applyFilters);
  document.getElementById("searchInput").addEventListener("input", applyFilters);

  const favToggle = document.getElementById("filterFavorites");
  favToggle.addEventListener("click", () => {
    favToggle.classList.toggle("active");
    showGridList();
    applyFilters();
  });

  document.addEventListener("mxFavoritesChanged", applyFilters);
}

/* ---------------------------------------------------------
   INIT
--------------------------------------------------------- */
loadBooks().then(initEvents);

</script>
</body>
</html>
